# Pumba Development Guide

## Build & Test Commands

- **Build:** `make build` (builds for current TARGETOS/TARGETARCH)
- **Build cg-inject:** `make build-cg-inject` (builds static cg-inject binary)
- **Full pipeline:** `make all` (format → lint → test → build)
- **Unit tests:** `make test` (requires `CGO_ENABLED=1` for race detector)
- **Test with coverage:** `make test-coverage`
- **Race detector:** `make test-race` (linux/amd64 only)
- **Lint:** `make lint` (runs golangci-lint with `.golangci.yaml`)
- **Format:** `make fmt`
- **Cross-compile:** `make release` (darwin/linux/windows × amd64/arm64)
- **Integration tests:** `make integration-tests` (requires Docker, uses bats)
- **All integration tests:** `make integration-tests-all` (includes stress tests)
- **Generate mocks:** `make mocks` (uses mockery)

## Integration Testing

Integration tests use [bats](https://github.com/bats-core/bats-core) and run inside Docker:

- Tests are in `tests/*.bats` with helpers in `tests/test_helper.bash`
- Require Docker socket access (`/var/run/docker.sock`)
- CI builds a Docker image (`pumba:test` target `integration-tests`) and runs bats inside it
- Run locally: `bats tests/*.bats` (needs pumba binary in PATH and Docker running)

## Technical Stack

- **Go version:** 1.26 (see go.mod)
- **CLI framework:** `github.com/urfave/cli` (v1)
- **Docker SDK:** `github.com/docker/docker` v28.5.2
- **Error handling:** `github.com/pkg/errors` (deprecated — migrate to `fmt.Errorf` with `%w`)
- **Logging:** `github.com/sirupsen/logrus`
- **Testing:** `github.com/stretchr/testify` (assert, mock, require)
- **Mocking:** `github.com/vektra/mockery`
- **Linting:** golangci-lint with `.golangci.yaml`
- **CI:** GitHub Actions (build.yaml, release.yaml, codeql-analysis.yml, nettools-images.yaml)

## Project Structure

```
cmd/main.go            — CLI entry point, all command/flag definitions
cmd/cg-inject/         — cg-inject binary: moves process into target container's cgroup
pkg/
  chaos/
    command.go         — ChaosCommand interface, scheduling/interval runner
    docker/            — Docker chaos actions (kill, stop, pause, rm, exec, restart)
    docker/cmd/        — CLI command builders for docker chaos actions
    netem/             — Network emulation (delay, loss, corrupt, duplicate, rate, loss_ge, loss_state)
    netem/cmd/         — CLI command builders for netem
    iptables/          — iptables-based packet filtering
    iptables/cmd/      — CLI command builders for iptables
    stress/            — stress-ng based resource stress
    stress/cmd/        — CLI command builder for stress
  container/           — Docker client abstraction, container types, filtering
  util/                — Shared utilities (IP/port parsing)
mocks/                 — Generated mock files (mockery)
tests/                 — Bats integration tests
docker/                — Dockerfiles (main, alpine-nettools, debian-nettools, stress)
deploy/                — K8s/OpenShift deployment manifests
examples/              — Demo scripts
```

## Architecture

- **Container client** (`pkg/container/client.go`): Interface over Docker API for listing, killing, stopping, pausing, exec, netem, stress operations
- **Docker client** (`pkg/container/docker_client.go`): Concrete implementation using Docker SDK
- **Chaos commands**: Each action implements `ChaosCommand` interface with `Run(ctx, random)` method
- **Network emulation**: Executes `tc` commands inside a sidecar container via Docker exec
- **Stress testing**: Two modes — (1) default child-cgroup mode places stress-ng sidecar in target's cgroup via Docker's `--cgroup-parent`; (2) inject-cgroup mode (`--inject-cgroup`) uses `cg-inject` binary to write sidecar PID into target's `cgroup.procs` for shared resource accounting
- **Target selection**: Container names (exact), comma-separated lists, or `re2:` prefixed regex patterns
- **Label filtering**: `--label key=value` flags for container selection
- **Interval mode**: `--interval` flag for recurring chaos on a schedule

## Code Conventions

- **Error wrapping:** Currently uses `github.com/pkg/errors` — migrate to `fmt.Errorf("...: %w", err)`
- **Interfaces:** Define interfaces for testability (Client in `pkg/container/client.go`)
- **Mocking:** testify mocks, generated by mockery. Mock files in `mocks/` and `pkg/container/mock_*.go`
- **Logging:** logrus with structured fields. Log level set via `--log-level` flag
- **Constants:** Magic numbers use `mnd` linter — use named constants
- **Default branch:** `master`
- **NEVER add AI co-author to git commits**
