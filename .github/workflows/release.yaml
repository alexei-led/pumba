name: Release

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'

jobs:
  # Build and test Go binaries
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set Up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.26'
          cache: true
          cache-dependency-path: go.sum

      - name: Run Lint and Test Coverage
        run: |
          make lint
          make test-coverage

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ".cover/coverage.xml"
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Build Release Binaries
        env:
          GOPROXY: https://proxy.golang.org
          CGO_ENABLED: 0
        run: make release

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pumba-binaries
          path: .bin/*
          retention-days: 7
          compression-level: 6
          include-hidden-files: true

  # Build Docker images natively per architecture (no QEMU)
  docker-build:
    strategy:
      matrix:
        include:
          - platform: linux/amd64
            runner: ubuntu-24.04
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Short SHA
        id: short_sha
        run: echo "sha=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_ACCOUNT }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build and push by digest (GHCR)
        id: build-ghcr
        uses: docker/build-push-action@v6
        with:
          file: docker/Dockerfile
          context: .
          build-args: |
            BRANCH=${{ github.ref_name }}
            COMMIT=${{ steps.short_sha.outputs.sha }}
            SKIP_TESTS=true
          platforms: ${{ matrix.platform }}
          outputs: type=image,name=ghcr.io/${{ github.repository }},push-by-digest=true,name-canonical=true,push=true
          cache-from: type=gha,scope=${{ matrix.platform }}
          cache-to: type=gha,mode=max,scope=${{ matrix.platform }}
          provenance: false

      - name: Build and push by digest (Docker Hub)
        id: build-hub
        uses: docker/build-push-action@v6
        with:
          file: docker/Dockerfile
          context: .
          build-args: |
            BRANCH=${{ github.ref_name }}
            COMMIT=${{ steps.short_sha.outputs.sha }}
            SKIP_TESTS=true
          platforms: ${{ matrix.platform }}
          outputs: type=image,name=${{ secrets.DOCKER_ORG }}/pumba,push-by-digest=true,name-canonical=true,push=true
          cache-from: type=gha,scope=${{ matrix.platform }}
          provenance: false

      - name: Export digests
        run: |
          mkdir -p /tmp/digests/ghcr /tmp/digests/hub
          ghcr_digest="${{ steps.build-ghcr.outputs.digest }}"
          hub_digest="${{ steps.build-hub.outputs.digest }}"
          touch "/tmp/digests/ghcr/${ghcr_digest#sha256:}"
          touch "/tmp/digests/hub/${hub_digest#sha256:}"

      - name: Upload digests
        uses: actions/upload-artifact@v4
        with:
          name: digests-${{ matrix.runner }}
          path: /tmp/digests
          if-no-files-found: error
          retention-days: 1

  # Merge multi-arch manifests
  docker-merge:
    runs-on: ubuntu-latest
    needs: docker-build
    permissions:
      contents: read
      packages: write
    steps:
      - name: Download digests
        uses: actions/download-artifact@v4
        with:
          path: /tmp/digests
          pattern: digests-*
          merge-multiple: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_ACCOUNT }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Create and push manifest (GHCR)
        working-directory: /tmp/digests/ghcr
        run: |
          printf 'ghcr.io/${{ github.repository }}@sha256:%s\n' * > /tmp/ghcr-sources.txt
          readarray -t sources < /tmp/ghcr-sources.txt
          docker buildx imagetools create \
            -t "ghcr.io/${{ github.repository }}:${{ github.ref_name }}" \
            -t "ghcr.io/${{ github.repository }}:latest" \
            "${sources[@]}"

      - name: Create and push manifest (Docker Hub)
        working-directory: /tmp/digests/hub
        run: |
          printf '${{ secrets.DOCKER_ORG }}/pumba@sha256:%s\n' * > /tmp/hub-sources.txt
          readarray -t sources < /tmp/hub-sources.txt
          docker buildx imagetools create \
            -t "${{ secrets.DOCKER_ORG }}/pumba:${{ github.ref_name }}" \
            -t "${{ secrets.DOCKER_ORG }}/pumba:latest" \
            "${sources[@]}"

      - name: Inspect GHCR image
        run: docker buildx imagetools inspect "ghcr.io/${{ github.repository }}:${{ github.ref_name }}"

  # Create GitHub Release
  create-release:
    name: Create GitHub Release
    needs: [build, docker-merge]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: pumba-binaries
          path: ${{ github.workspace }}/.bin/

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          generateReleaseNotes: true
          prerelease: false
          artifacts: ${{ github.workspace }}/.bin/*
          allowUpdates: false
          commit: ${{ github.sha }}
          draft: false
